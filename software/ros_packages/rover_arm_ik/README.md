# Rover Arm IK Packages Overview

This document provides a brief overview of the main software packages responsible for autonomous operation of the arm. This document aims to inform members about the structure an purpose of each package, as well as how to launch different files for simulation and control. Two main libraries allow us the functionality to preform autonomous operations with the arm: ROS_Control and Moveit!. Moveit! provides us with a number of different plugins and packages for simulating motion, motion planning, and improved kinematics on our arm. ROS Control provides us with the framework to connect the planned motions from Moveit! libraries with the actual hardware of the arm. In the sections below, a more in depth overview of how these two libraries function is presented.

## Package Descriptions

### rover_arm_control

The ```rover_arm_control``` package encompasses the code responsible for linking simulated/planned motions to real robot hardware. It is the implementation of the ROS Control library. The main pieces of software in this package are the hardware interface, and the joint controllers. Joint controllers are the ROS nodes responsible for keeping track of information about the joints of the arm. Joint controllers in the simplest sense, are what are responsible for taking commands from simulated/planned motion and executing it on the physical arm. The hardware interface is repsonsible for providing these controllers with the capability to interface with the real hardware of the arm.

### rover_arm_description

The ```rover_arm_description``` package is what stores the URDF model for the arm. The URDF model file is what contains information about limits and physical characteristics of every joint on the arm. It is what tells the simulator and the control package how the joints are linked together and how they interact with one another. The files in this package are used by many of the packages for arm autonomy.

### rover_arm_gazebo

The ```rover_arm_gazebo``` package is responsible for taking the URDF model of the arm and launching it in Gazebo- a full 3D physics simulator. Gazebo provides a good approximation of real life behavior of the arm through simulation. This package contains joint controllers that publish false joint data for simulation purposes, so the simulation here is not connected to actual hardware. 

### rover_arm_moveit_config

### stomp_core

### stomp_moveit

### joint_parser

## Simulating Arm Control Using RViz and Gazebo

## Running the Arm With ROS Control

## Generating IK Solutions and Plugins

The below instructions were adapted from the official Moveit! Documentatation on IKFAST. A link to these docs can be found in the references section at the end of this document. These instructions assume you already have installed OpenRAVE on your machine. If you need to do that a good tutorial can be found [here](https://scaron.info/teaching/installing-openrave-on-ubuntu-16.04.html). <br>

### 1. Converting URDF to COLLADA

IKFAST works with a 3D file type called COLLADA (COLLAborative Design Activity). The standard file used for Moveit! is URDF, so in order to utilize OpenRAVE and IKFAST, URDF files must be converted to COLLADA. Luckily, there is a nice script that is meant for this specific purpose. <br>

* First, run ```sudo apt-get install ros-kinetic-collada-urdf``` to install the necessary scripts for conversion
* Then, run ```rosrun collada_urdf urdf_to_collada "$MYROBOT_NAME".urdf "$MYROBOT_NAME".dae``` where ```$MYROBOT_NAME``` is the file name and path for the URDF file to be converted.
* To test if the file has been correctly converted run ```openrave "$MYROBOT_NAME".dae``` where ```$MYROBOT_NAME``` is the file name and path for the COLLADA file
* Joint link information can be displayed with the command ```openrave-robot.py "$MYROBOT_NAME".dae --info links``` where ```$MYROBOT_NAME``` is the file name and path for the COLLADA file

### 2. Generating Solution CPP File

In order to use IK with Moveit!, a solution file has to be generated. This file is generated by OpenRAVE and is a mathematical analysis of the joints of the input COLLADA file. Typical inverse kinematics calculations make extensive use of linear algebra and trigonometry, but an understanding of higher mathematics is not necessary to run OpenRAVE and generate the solution file. For more mathematically curious/inclined members: Angela Sodemann, an assistant professor at Arizona State University, has an entire free lecture video series about robotics principles, including all the mathematics behind them. Her youtube channel can be found [here](https://www.youtube.com/user/asodemann3/videos) <br>

1. First, the type of IK needs to be selected. There are about 11 different types of IK that are supported by OpenRAVE and an extensive list can be found [here](http://openrave.org/docs/latest_stable/openravepy/ikfast/#ik-types). The default type of IK is ```Transform6D``` which means that the end effector will reach a desired transformation in 6D space. The type of IK chosen will be specified as the variable ```iktype=[desired ik type]```.
1. Next, a planning group must be chosen. This planning group name is the same as what is specified in the srdf file generated by the Moveit! Setup. Set this to an environment variable using the command ```export PLANNING_GROUP="group_name"``` where ```group_name``` is the planning name from the srdf file.
1. In order to properly generate a solution file for IK, the end effector and base links need to be specified. To get the joint information run the command ```openrave-robot.py "$MYROBOT_NAME".dae --info links``` where ```$MYROBOT_NAME``` is the file name and path for the COLLADA file.
1. Once the above command is run, identify the numbers corresponding to the base and end effector link. These can then be exported as environment variables ```export BASE_LINK="N"``` 
and ```export EEF_LINK="N"``` where ```N``` is the number corresponding to the links.
1. Now it's time to set the name for the output file. Moveit!'s recommended naming can be generated by using the following command ````export IKFAST_OUTPUT_PATH=`pwd`/ikfast61_"$PLANNING_GROUP".cpp```. The path can be changed to output the file in the desired directory, and the name of the file can also be changed as needed. 
1. Finally, for a 6DOF arm, run the following command to actually generate the IK solution file python ````openrave-config --python-dir`/openravepy/_openravepy_/ikfast.py --robot="$MYROBOT_NAME".dae --iktype=[desired ik type] --baselink="$BASE_LINK" --eelink="$EEF_LINK" --savefile="$IKFAST_OUTPUT_PATH"```. Make sure to replace ```[desired ik type]``` with the IK type selected earlier. 
    1. A note: The solution process shouldn't take over an hour! Typically solutions can be generated under 10 minutes, but every robot is different. If this ends up occuring, run the commands: ```export IKFAST_PRECISION="5" cp "$MYROBOT_NAME".dae "$MYROBOT_NAME".backup.dae``` ```rosrun moveit_kinematics round_collada_numbers.py "$MYROBOT_NAME".dae "$MYROBOT_NAME".dae "$IKFAST_PRECISION"``` Where ```$MYROBOT_NAME```  is the file name and path for the COLLADA file. This command rounds off the numbers in the COLLADA file, which makes the math easier for the solver to perform.

    1. As the command runs, you can actually see a bit of the linear algebra that's being performed! 
1. Once the IK solution file is generated, it can then be used in plugins!

## References

### General References for Moveit! and Gazebo

[Official Moveit! Documentation](https://docs.ros.org/en/kinetic/api/moveit_tutorials/html/index.html) <br>
[Official Gazebo Documentation for ROS](http://gazebosim.org/tutorials?cat=connect_ros)


### ROS Control Resources

[ROS Control Boilerplate Code](https://github.com/PickNikRobotics/ros_control_boilerplate/tree/kinetic-devel) by PikNik Robotics <br>
[ROS Control Tutorial](https://medium.com/%40slaterobotics/how-to-implement-ros-control-on-a-custom-robot-748b52751f2e) by Slate Robotics <br>
[Official ROS Control Repository](https://github.com/ros-controls/ros_control)

### Inverse Kinematics Resources

[Documentation for using Moveit! and IKFAST](https://docs.ros.org/en/kinetic/api/moveit_tutorials/html/doc/ikfast/ikfast_tutorial.html) <br>
[Offical OpenRAVE documentation](http://www.openrave.org/docs/latest_stable/) <br>
[Installing OpenRAVE tutotrial](https://scaron.info/teaching/installing-openrave-on-ubuntu-16.04.html) <br>
[Lecture Videos Covering Kinematics Math](https://www.youtube.com/user/asodemann3/videos) <br>
